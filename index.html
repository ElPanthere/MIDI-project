<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Piano MIDI – Portable (1 fichier)</title>
  <style>
    :root {
      --bg:#0b0b0f; --panel:#1b1b22; --muted:#2a2a33; --text:#f3f4f6; --sub:#c7cad1;
      --emerald:#10b981; --indigo:#6366f1; --amber:#f59e0b; --rose:#f43f5e;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .container { max-width:1100px; margin:0 auto; padding:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
    h1 { font-size:28px; margin:0 0 8px; }
    button, .btn { border:0; background:var(--panel); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; }
    button:hover { filter:brightness(1.1); }
    .btn-emerald{ background:var(--emerald); color:#04110c; }
    .btn-indigo{ background:var(--indigo); }
    .btn-amber{ background:var(--amber); color:#1b1302; }
    .btn-rose{ background:var(--rose); }
    select, input[type=range] { background:var(--panel); color:var(--text); border:1px solid var(--muted); border-radius:10px; padding:6px 8px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .panel { background:rgba(0,0,0,.35); border:1px solid var(--muted); border-radius:16px; }
    .notes { height:380px; overflow:hidden; }
    .kbd { position:relative; user-select:none; }
    .kbd .whites { display:flex; border:1px solid var(--muted); border-top:0; border-radius:0 0 16px 16px; overflow:hidden; }
    .kbd .white { flex:1 1 0; height:200px; background:#fff; color:#000; border-right:1px solid var(--muted); position:relative; }
    .kbd .white:last-child { border-right:0; }
    .kbd .white.down { background:#ebebeb; }
    .kbd .black-wrap { pointer-events:none; position:absolute; left:0; right:0; top:0; height:120px; }
    .kbd .black { pointer-events:auto; position:absolute; width:5.5%; height:100%; background:#000; border-radius:0 0 10px 10px; }
    .kbd .black.down { background:#444; }
    .tag { position:absolute; left:6px; bottom:6px; font-size:11px; padding:2px 4px; border-radius:6px; background:rgba(255,255,255,.85); color:#000; }
    .tag.black { background:rgba(0,0,0,.75); color:#fff; }
    .remap { position:absolute; right:6px; top:6px; font-size:10px; padding:2px 6px; border-radius:8px; background:#0d0d12; color:#fff; opacity:.75; }
    .remap:hover { opacity:1; }
    .help { padding:14px; }
    details { background:rgba(255,255,255,.03); border:1px solid var(--muted); border-radius:12px; }
    summary { cursor:pointer; padding:8px 12px; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50; }
    .overlay .card { background:#14141a; border:1px solid var(--muted); padding:20px; border-radius:14px; max-width:520px; text-align:center; }
  </style>
  <!-- React + ReactDOM + Babel (pour JSX dans le navigateur) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tone.js & @tonejs/midi -->
  <script src="https://unpkg.com/tone/build/Tone.js"></script>
  <script src="https://unpkg.com/@tonejs/midi/dist/Midi.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useMemo, useRef, useCallback} = React;
    const NOTE_RANGE = { first: 48, last: 84 };
    const WHITE_KEYS = [0,2,4,5,7,9,11];
    const KEYBOARD_DEFAULT = ["z","s","x","d","c","v","g","b","h","n","j","m",",","l",".",";","/","1","q","2","w","3","e","r","5","t","6","y","7","u","i","9","o","0","p","[","]"];
    const midiToName = (m)=>{ const names=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; return names[m%12]+(Math.floor(m/12)-1); };
    const isWhite = (m)=> WHITE_KEYS.includes(m%12);
    const buildNotes = (a,b)=> Array.from({length:b-a+1},(_,i)=>a+i);

    function App(){
      const [notes] = useState(()=>buildNotes(NOTE_RANGE.first, NOTE_RANGE.last));
      const [mapping, setMapping] = useState(()=>{
        try{ const s=localStorage.getItem('piano-keymap'); if(s) return JSON.parse(s);}catch{}
        const o={}; buildNotes(NOTE_RANGE.first, NOTE_RANGE.last).forEach((m,i)=>o[m]=KEYBOARD_DEFAULT[i]||"");
        return o;
      });
      const mappingRef = useRef(mapping); useEffect(()=>{mappingRef.current=mapping},[mapping]);

      const [pressed,setPressed] = useState(new Set());
      const pressedRef = useRef(pressed); useEffect(()=>{pressedRef.current=pressed},[pressed]);

      const synth = useMemo(()=> new Tone.PolySynth(Tone.Synth).toDestination(), []);
      const [ready,setReady]=useState(false);

      const [midiData, setMidiData] = useState(null);
      const [scheduled, setScheduled] = useState([]);
      const [isPlaying, setIsPlaying] = useState(false);
      const [pixelsPerSecond, setPixelsPerSecond] = useState(120);
      const [trackIndex, setTrackIndex] = useState('all');

      const canvasRef = useRef(null);

      const ensureAudio = async ()=>{
        if (Tone.getContext().state !== 'running') await Tone.start();
        setReady(true);
      };

      const noteOn = useCallback((midi)=>{
        const now = Tone.now();
        synth.triggerAttack(Tone.Frequency(midi,'midi'), now);
        setPressed(prev=> new Set(prev).add(midi));
      },[synth]);

      const noteOff = useCallback((midi)=>{
        synth.triggerRelease(Tone.Frequency(midi,'midi'));
        setPressed(prev=>{ const s=new Set(prev); s.delete(midi); return s; });
      },[synth]);

      useEffect(()=>{
        const down = (e)=>{
          if(!ready) return;
          const tag = document.activeElement?.tagName?.toLowerCase();
          if(tag==='input'||tag==='textarea') return;
          const entry = Object.entries(mappingRef.current).find(([,key])=> key && key.toLowerCase()===e.key.toLowerCase());
          if(entry){ const midi=Number(entry[0]); if(!pressedRef.current.has(midi)) noteOn(midi); e.preventDefault(); }
        };
        const up = (e)=>{
          const entry = Object.entries(mappingRef.current).find(([,key])=> key && key.toLowerCase()===e.key.toLowerCase());
          if(entry){ const midi=Number(entry[0]); noteOff(midi); e.preventDefault(); }
        };
        window.addEventListener('keydown',down);
        window.addEventListener('keyup',up);
        return ()=>{ window.removeEventListener('keydown',down); window.removeEventListener('keyup',up); };
      },[ready,noteOn,noteOff]);

      const [remappingMidi, setRemappingMidi] = useState(null);
      useEffect(()=>{
        if(remappingMidi==null) return;
        const handler = (e)=>{
          e.preventDefault();
          const newKey = e.key.length===1 ? e.key : '';
          setMapping(prev=>{
            const clone={...prev};
            for(const m in clone){ if(clone[m] && clone[m].toLowerCase()===newKey.toLowerCase()) clone[m]=''; }
            clone[remappingMidi]=newKey;
            try{localStorage.setItem('piano-keymap', JSON.stringify(clone));}catch{}
            return clone;
          });
          setRemappingMidi(null);
        };
        window.addEventListener('keydown', handler, {once:true});
        return ()=> window.removeEventListener('keydown', handler);
      },[remappingMidi]);

      const onSelectMidi = async (file)=>{
        if(!file) return;
        const ab = await file.arrayBuffer();
        const midi = new Midi(ab);
        setMidiData(midi);
        const all=[];
        midi.tracks.forEach((track,idx)=>{
          track.notes.forEach(n=> all.push({track:idx, time:n.time, duration:n.duration, midi:n.midi, velocity:n.velocity}));
        });
        all.sort((a,b)=>a.time-b.time);
        setScheduled(all);
        setTrackIndex('all');
        Tone.Transport.seconds = 0;
      };

      const schedulePlayback = ()=>{
        if(!midiData) return;
        Tone.Transport.cancel();
        const events = (trackIndex==='all')? scheduled : scheduled.filter(n=>n.track===Number(trackIndex));
        events.forEach(n=>{
          Tone.Transport.schedule((time)=>{
            synth.triggerAttackRelease(Tone.Frequency(n.midi,'midi'), n.duration, time, n.velocity);
            flashKey(n.midi, time, n.duration);
          }, n.time);
        });
      };

      const flashKey = (midi, time, dur)=>{
        setTimeout(()=> setPressed(prev=> new Set(prev).add(midi)), Math.max(0,(time - Tone.now())*1000));
        setTimeout(()=> setPressed(prev=>{ const s=new Set(prev); s.delete(midi); return s; }), Math.max(0,(time - Tone.now() + dur)*1000));
      };

      const play = async ()=>{ await ensureAudio(); schedulePlayback(); await Tone.start(); Tone.Transport.start(); setIsPlaying(true); };
      const pause = ()=>{ Tone.Transport.pause(); setIsPlaying(false); };
      const stop  = ()=>{ Tone.Transport.stop(); Tone.Transport.seconds = 0; setIsPlaying(false); };

      useEffect(()=>{
        let raf;
        const ctx = canvasRef.current?.getContext('2d');
        const render = ()=>{
          raf = requestAnimationFrame(render);
          if(!ctx) return;
          const canvas = ctx.canvas;
          const parent = canvas.parentElement;
          const dpr = window.devicePixelRatio || 1;
          const width = parent.clientWidth;
          const height = parent.clientHeight;
          if(canvas.width!==width*dpr || canvas.height!==height*dpr){
            canvas.width = width*dpr; canvas.height = height*dpr;
            canvas.style.width = width+'px'; canvas.style.height = height+'px';
            ctx.setTransform(dpr,0,0,dpr,0,0);
          }
          ctx.clearRect(0,0,width,height);
          const whiteNotes = notes.filter(isWhite);
          const keyWidth = width / whiteNotes.length;
          whiteNotes.forEach((_,i)=>{
            ctx.fillStyle = i%2 ? '#0b1220' : '#111827';
            ctx.fillRect(i*keyWidth,0,keyWidth-1,height);
          });
          const nowSec = Tone.Transport.seconds;
          const speed = pixelsPerSecond;
          const startWindow = nowSec - 1;
          const endWindow = nowSec + height/speed + 2;
          const events = (trackIndex==='all')? scheduled : scheduled.filter(n=>n.track===Number(trackIndex));
          const whiteIndexOf = (m)=> whiteNotes.indexOf(isWhite(m)?m:m-1);
          events.forEach(n=>{
            if(n.time > endWindow || n.time + n.duration < startWindow) return;
            const y0 = (n.time - nowSec) * speed;
            const h  = Math.max(4, n.duration * speed);
            const idx = whiteIndexOf(n.midi);
            if(idx<0) return;
            const x = idx*keyWidth + (isWhite(n.midi)?0:keyWidth*0.25);
            const w = isWhite(n.midi) ? keyWidth*0.9 : keyWidth*0.5;
            const hue = (n.midi % 12) * (360/12);
            ctx.fillStyle = `hsl(${hue},70%,55%)`;
            ctx.globalAlpha = 0.9;
            ctx.fillRect(x, height - y0 - h, w, h);
            ctx.globalAlpha = 1;
          });
          ctx.strokeStyle = '#ffffff';
          ctx.beginPath(); ctx.moveTo(0,height-2); ctx.lineTo(width,height-2); ctx.stroke();
        };
        raf = requestAnimationFrame(render);
        return ()=> cancelAnimationFrame(raf);
      },[notes, pixelsPerSecond, scheduled, trackIndex]);

      const whiteKeys = notes.filter(isWhite);
      const blackKeyFor = (base)=>{
        const pc = base % 12;
        if(pc===0) return base+1; // C#
        if(pc===2) return base+1; // D#
        if(pc===5) return base+1; // F#
        if(pc===7) return base+1; // G#
        if(pc===9) return base+1; // A#
        return null;
      };

      return (
        <div className="container">
          <div className="row">
            <div style={{flex:'1 1 auto'}}>
              <h1>Piano en ligne + Chute de notes (MIDI)</h1>
            </div>
            <div className="controls">
              <button className="btn-emerald" onClick={ensureAudio}>Activer l'audio</button>
              <label className="btn btn-indigo" style={{cursor:'pointer'}}>
                Importer un MIDI
                <input type="file" accept=".mid,.midi" style={{display:'none'}}
                       onChange={(e)=> onSelectMidi(e.target.files?.[0]) } />
              </label>
              <label className="btn" style={{display:'inline-flex', alignItems:'center', gap:8}}>
                Vitesse
                <input type="range" min="60" max="300" value={pixelsPerSecond}
                       onChange={(e)=> setPixelsPerSecond(Number(e.target.value)) } />
              </label>
            </div>
          </div>

          {midiData && (
            <div className="row" style={{alignItems:'center', marginTop:8}}>
              <span style={{opacity:.8}}>Pistes :</span>
              <select value={trackIndex} onChange={(e)=> setTrackIndex(e.target.value)}>
                <option value="all">Toutes</option>
                {midiData.tracks.map((t,i)=> <option key={i} value={i}>{`Piste ${i+1} – ${t.name || '(sans nom)'}`}</option>)}
              </select>
              <div style={{marginLeft:'auto', display:'flex', gap:8}}>
                {!isPlaying ? (
                  <button className="btn-emerald" onClick={play}>Lecture</button>
                ) : (
                  <button className="btn-amber" onClick={pause}>Pause</button>
                )}
                <button className="btn-rose" onClick={stop}>Stop</button>
              </div>
            </div>
          )}

          <div className="panel notes" style={{marginTop:12}}>
            <canvas ref={canvasRef} style={{display:'block', width:'100%', height:'100%'}} />
          </div>

          <div className="kbd" style={{marginTop:16}}>
            <div className="whites">
              {whiteKeys.map((midi)=>(
                <div key={midi}
                  className={'white'+(pressed.has(midi)?' down':'')}
                  onMouseDown={()=>{ ensureAudio(); noteOn(midi); }}
                  onMouseUp={()=> noteOff(midi) }
                  onMouseLeave={()=> pressed.has(midi) && noteOff(midi) }
                >
                  <div className="tag">{midiToName(midi)} {mapping[midi]?`· ${mapping[midi]}`:''}</div>
                  <button className="remap" onClick={(e)=>{e.stopPropagation(); setRemappingMidi(midi);}}>Remap</button>
                </div>
              ))}
            </div>
            <div className="black-wrap">
              {whiteKeys.map((base,i)=>{
                const b = blackKeyFor(base);
                if(!b || b>NOTE_RANGE.last) return null;
                const leftPercent = (i + 1) * (100 / whiteKeys.length) - (100 / whiteKeys.length) * 0.35;
                const isDown = pressed.has(b);
                return (
                  <div key={b}
                    className={'black'+(isDown?' down':'')}
                    style={{ left: leftPercent + '%'}}
                    onMouseDown={(e)=>{ e.stopPropagation(); ensureAudio(); noteOn(b); }}
                    onMouseUp={(e)=>{ e.stopPropagation(); noteOff(b); }}
                    onMouseLeave={(e)=>{ e.stopPropagation(); isDown && noteOff(b); }}
                  >
                    <div className="tag black">{midiToName(b)} {mapping[b]?`· ${mapping[b]}`:''}</div>
                    <button className="remap" onClick={(e)=>{ e.stopPropagation(); setRemappingMidi(b); }}>Remap</button>
                  </div>
                );
              })}
            </div>
          </div>

          <details className="help" style={{marginTop:12}}>
            <summary>Aide</summary>
            <ul>
              <li>Active l'audio puis joue au clic ou au clavier (touches remappables).</li>
              <li>Importe un fichier .mid pour la chute de notes + lecture synchronisée.</li>
              <li>Ajuste la vitesse avec le curseur « Vitesse ».</li>
              <li>Choisis une piste spécifique ou « Toutes ».</li>
              <li>La configuration clavier est sauvegardée localement.</li>
            </ul>
          </details>

          <div style={{textAlign:"center", opacity:.65, fontSize:12, padding:"20px 0"}}>Fait avec React, Tone.js et @tonejs/midi. Aucun envoi de fichier – tout reste en local.</div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
